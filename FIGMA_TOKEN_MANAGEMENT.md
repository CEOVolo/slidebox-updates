# Управление Figma токеном

## Обзор

В системе SlideDeck 2.0 реализовано удобное управление Figma Access Token через веб-интерфейс. Это позволяет легко обновлять токен без необходимости изменения файлов конфигурации или переменных окружения.

## Как это работает

### 1. Хранение токена

Figma токен хранится в базе данных в таблице `SystemSettings`. При первом запуске, если токен не найден в базе данных, система автоматически возьмет его из переменной окружения `FIGMA_ACCESS_TOKEN` и сохранит в базу.

### 2. Доступ к настройкам

Управление токеном доступно администраторам через страницу настроек:
1. Войдите в систему как администратор
2. Перейдите в раздел "Moderation" 
3. Нажмите "System Settings"
4. Выберите вкладку "System Settings"

### 3. Функции управления

#### Просмотр текущего токена
- Токен отображается в маскированном виде (первые 10 и последние 4 символа)
- Статус "Активен" показывает, что токен установлен

#### Редактирование токена
1. Нажмите кнопку редактирования (карандаш)
2. Введите новый токен в поле ввода
3. Проверьте токен кнопкой "Проверить токен"
4. Сохраните изменения кнопкой "Сохранить"

#### Проверка токена
- Система автоматически проверяет валидность токена через Figma API
- При успешной проверке отображается email пользователя Figma
- При ошибке выводится сообщение о недействительности токена

## Техническая реализация

### База данных

```sql
-- Таблица для хранения системных настроек
model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### API endpoints

- `GET /api/system/settings?key=FIGMA_ACCESS_TOKEN` - получение токена
- `POST /api/system/settings` - обновление токена
- `DELETE /api/system/settings?key=FIGMA_ACCESS_TOKEN` - удаление токена

### Утилита для работы с токеном

`lib/figma-token.ts` предоставляет функции:
- `getFigmaAccessToken()` - получение токена с кэшированием
- `updateFigmaAccessToken(token)` - обновление токена
- `validateFigmaToken(token)` - проверка валидности
- `clearTokenCache()` - очистка кэша

### Кэширование

Токен кэшируется в памяти на 5 минут для уменьшения нагрузки на базу данных.

## Безопасность

1. Токен хранится в защищенной базе данных
2. Доступ к управлению токеном только у администраторов
3. Токен отображается в маскированном виде
4. При передаче по сети используется HTTPS

## Миграция

Для использования новой функциональности:

1. Примените миграцию базы данных:
```bash
npx prisma migrate dev --name add_system_settings
```

2. Сгенерируйте Prisma клиент:
```bash
npx prisma generate
```

3. Обновите использование токена в коде:
```typescript
// Старый способ
const figmaToken = process.env.FIGMA_ACCESS_TOKEN;

// Новый способ
import { getFigmaAccessToken } from '@/lib/figma-token';
const figmaToken = await getFigmaAccessToken();
```

## Получение Figma токена

1. Войдите в [Figma](https://www.figma.com)
2. Перейдите в Settings → Account
3. В разделе "Personal access tokens" нажмите "Create new token"
4. Введите описание токена и скопируйте его
5. Вставьте токен в систему SlideDeck

## Поддержка

При возникновении проблем:
1. Проверьте валидность токена через интерфейс
2. Убедитесь, что у токена есть необходимые права в Figma
3. Проверьте логи сервера на наличие ошибок 